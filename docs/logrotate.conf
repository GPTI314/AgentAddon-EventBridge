# Log rotation configuration for AgentAddon services
#
# Installation:
# 1. Copy this file to /etc/logrotate.d/agentaddon
# 2. Ensure logs are written to /var/log/agentaddon/
# 3. Test with: logrotate -d /etc/logrotate.d/agentaddon
#
# For Docker deployments, use Docker's logging driver instead.
# See docker-compose.yml for example configuration.

/var/log/agentaddon/*.log {
    # Rotate daily
    daily

    # Keep 7 days of logs
    rotate 7

    # Compress old logs
    compress

    # Delay compression until next rotation
    delaycompress

    # Don't error if log file is missing
    missingok

    # Don't rotate empty logs
    notifempty

    # Create new log file with these permissions
    # Format: mode owner group
    create 0640 app app

    # Use shared scripts for all logs
    sharedscripts

    # Command to run after rotation
    postrotate
        # Reload services to start writing to new log file
        # Adjust service names as needed
        systemctl reload agentaddon-eventbridge 2>/dev/null || true
        systemctl reload agentaddon-vectorhub 2>/dev/null || true
        systemctl reload agentaddon-secretgateway 2>/dev/null || true
    endscript

    # Date extension for rotated files (YYYYMMDD)
    dateext
    dateformat -%Y%m%d

    # Extension to use for compressed files
    extension .log
    compresscmd /bin/gzip
    compressext .gz
}

# Specific configuration for high-volume logs
/var/log/agentaddon/access.log {
    # Rotate when file reaches 100MB
    size 100M

    # Keep 14 rotations (approximately 1.4GB)
    rotate 14

    daily
    compress
    delaycompress
    missingok
    notifempty
    create 0640 app app
    sharedscripts

    postrotate
        systemctl reload agentaddon-* 2>/dev/null || true
    endscript

    dateext
    dateformat -%Y%m%d
}
